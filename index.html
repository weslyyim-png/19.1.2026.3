import React, { useState, useEffect, useRef } from 'react';
import { Play, RotateCcw, Check, Calculator, Package, Flower, HelpCircle } from 'lucide-react';

const FlowerShopMath = () => {
  // ç‹€æ…‹ç®¡ç†
  const [mode, setMode] = useState('menu'); // 'menu', 'interactive', 'demo'
  const [step, setStep] = useState(1); // 1: Division (Packing), 2: Addition (Total)
  
  // æ•¸æ“šç‹€æ…‹
  const [originalBouquets] = useState(11);
  const [totalLooseRoses] = useState(156);
  const [rosesPerBouquet] = useState(12);
  
  // å‹•ç•«ç‹€æ…‹
  const [currentLoose, setCurrentLoose] = useState(156);
  const [newBouquets, setNewBouquets] = useState(0);
  const [isPacking, setIsPacking] = useState(false);
  const [showFinalTotal, setShowFinalTotal] = useState(false);
  
  // ç”¨æˆ¶è¼¸å…¥ç‹€æ…‹
  const [inputDiv1, setInputDiv1] = useState('');
  const [inputDiv2, setInputDiv2] = useState('');
  const [inputDivAns, setInputDivAns] = useState('');
  
  const [inputAdd1, setInputAdd1] = useState('');
  const [inputAdd2, setInputAdd2] = useState('');
  const [inputAddAns, setInputAddAns] = useState('');
  
  const [feedback, setFeedback] = useState('');
  const [feedbackType, setFeedbackType] = useState('neutral'); // neutral, success, error

  // é‡ç½®å‡½æ•¸
  const resetGame = () => {
    setStep(1);
    setCurrentLoose(156);
    setNewBouquets(0);
    setIsPacking(false);
    setShowFinalTotal(false);
    setInputDiv1('');
    setInputDiv2('');
    setInputDivAns('');
    setInputAdd1('');
    setInputAdd2('');
    setInputAddAns('');
    setFeedback('');
    setFeedbackType('neutral');
  };

  const handleModeSelect = (selectedMode) => {
    setMode(selectedMode);
    resetGame();
    if (selectedMode === 'demo') {
      runDemo();
    }
  };

  // è‡ªå‹•æ¼”ç¤ºé‚è¼¯
  const runDemo = async () => {
    // Step 1: é–‹å§‹åŒ…è£
    setFeedback('é¡Œç›®ï¼šèŠ±åº—è£åŸæœ‰ç«ç‘° 11 æŸï¼Œå°‡ 156 ææ•£è£ç«ç‘°æ¯ 12 æåŒ…æˆä¸€æŸ...');
    await wait(3500); // å¢åŠ é–±è®€æ™‚é–“
    
    setFeedback('ç¬¬ä¸€æ­¥ï¼šè¨ˆç®—æ•£è£ç«ç‘°å¯ä»¥åŒ…æˆå¹¾æŸï¼Ÿ (156 Ã· 12)');
    setIsPacking(true);
    await wait(1000); // ç¨å¾®åœé “è®“å­¸ç”Ÿæº–å‚™çœ‹å‹•ç•«
    
    // æ¨¡æ“¬åŒ…è£å‹•ç•«
    let tempLoose = 156;
    let tempBouquets = 0;
    
    const packInterval = setInterval(() => {
      if (tempLoose >= 12) {
        tempLoose -= 12;
        tempBouquets += 1;
        setCurrentLoose(tempLoose);
        setNewBouquets(tempBouquets);
      } else {
        clearInterval(packInterval);
        setIsPacking(false);
        finishStep1Demo();
      }
    }, 600); // æ¸›æ…¢åŒ…è£é€Ÿåº¦ (åŸæœ¬200ms -> 600ms)
  };

  const finishStep1Demo = async () => {
    setFeedback('åŒ…è£å®Œæˆï¼æˆ‘å€‘å¾—åˆ°äº† 13 æŸæ–°ç«ç‘°ã€‚');
    // æ…¢æ…¢å¡«å…¥æ•¸å­—
    await wait(1000);
    setInputDiv1('156');
    await wait(800);
    setInputDiv2('12');
    await wait(800);
    setInputDivAns('13');
    await wait(3000); // åœç•™ä¹…ä¸€é»çœ‹çµæœ
    
    setStep(2);
    setFeedback('ç¬¬äºŒæ­¥ï¼šå°‡åŸæœ¬çš„ 11 æŸåŠ ä¸Šæ–°åŒ…å¥½çš„ 13 æŸã€‚');
    await wait(2500);
    
    // æ¨¡æ“¬å¡«å¯«ç¬¬äºŒæ­¥
    setInputAdd1('11');
    await wait(1000);
    setInputAdd2('13');
    await wait(1000);
    
    setShowFinalTotal(true);
    setInputAddAns('24');
    setFeedback('ç­”æ¡ˆç®—å‡ºï¼šç¸½å…±æœ‰ 24 æŸç«ç‘°ï¼');
    setFeedbackType('success');
  };

  const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

  // äº’å‹•æ¨¡å¼é‚è¼¯
  const checkStep1 = () => {
    if (parseInt(inputDiv1) === 156 && parseInt(inputDiv2) === 12 && parseInt(inputDivAns) === 13) {
      setFeedback('ç­”å°äº†ï¼156 é™¤ä»¥ 12 ç­‰æ–¼ 13 æŸã€‚');
      setFeedbackType('success');
      setIsPacking(true);
      
      // å¿«é€Ÿå®Œæˆå‹•ç•«
      let tempLoose = currentLoose;
      let tempBouquets = newBouquets;
      const packInterval = setInterval(() => {
        if (tempLoose >= 12) {
          tempLoose -= 12;
          tempBouquets += 1;
          setCurrentLoose(tempLoose);
          setNewBouquets(tempBouquets);
        } else {
          clearInterval(packInterval);
          setIsPacking(false);
          setTimeout(() => {
            setStep(2);
            setFeedback('ç¾åœ¨é€²å…¥ç¬¬äºŒæ­¥ï¼Œè¨ˆç®—ç¸½æ•¸ã€‚');
            setFeedbackType('neutral');
          }, 1000);
        }
      }, 50);
    } else {
      setFeedback('ç®—å¼å¥½åƒä¸å¤ªå°å–”ï¼Ÿè©¦è©¦çœ‹ï¼š156 æï¼Œæ¯ 12 æä¸€æŸã€‚');
      setFeedbackType('error');
    }
  };

  const checkStep2 = () => {
    if (
      (parseInt(inputAdd1) === 11 && parseInt(inputAdd2) === 13 && parseInt(inputAddAns) === 24) ||
      (parseInt(inputAdd1) === 13 && parseInt(inputAdd2) === 11 && parseInt(inputAddAns) === 24)
    ) {
      setFeedback('å¤ªæ£’äº†ï¼å®Œå…¨æ­£ç¢ºï¼ç¾æœ‰ 24 æŸç«ç‘°ã€‚');
      setFeedbackType('success');
      setShowFinalTotal(true);
    } else {
      setFeedback('å†æƒ³ä¸€æƒ³ï¼ŒåŸæœ‰ 11 æŸï¼ŒåŠ ä¸Šæ–°åŒ…å¥½çš„ 13 æŸ...');
      setFeedbackType('error');
    }
  };

  // UI å…ƒä»¶
  const BouquetIcon = ({ count, color = "text-rose-500" }) => (
    <div className="flex flex-col items-center m-1 transition-all duration-500 transform scale-100 hover:scale-110">
      <div className={`relative ${color}`}>
        <Flower size={32} fill="currentColor" strokeWidth={1.5} />
        <div className="absolute -bottom-1 -right-1 bg-green-500 rounded-full p-0.5">
          <div className="text-[10px] text-white font-bold px-1">12</div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-sky-50 font-sans text-gray-800 p-4 md:p-8 flex flex-col items-center">
      
      {/* Header */}
      <header className="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-6 mb-6 text-center border-b-4 border-sky-400">
        <h1 className="text-2xl md:text-3xl font-bold text-sky-600 mb-2">ğŸŒ¹ èŠ±åº—ç«ç‘°æ•¸å­¸é¡Œ ğŸŒ¹</h1>
        <p className="text-gray-600 text-lg">
          é¡Œç›®ï¼šåŸæœ‰ <strong>11</strong> æŸï¼Œåº—å“¡å†æŠŠ <strong>156</strong> æç«ç‘°åŒ…è£æˆæ¯ <strong>12</strong> æä¸€æŸï¼ŒèŠ±åº—ç¾æœ‰ç«ç‘°å¤šå°‘æŸï¼Ÿ
        </p>
      </header>

      {/* Main Game Area */}
      <div className="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col md:flex-row min-h-[500px]">
        
        {/* Left: Visualization */}
        <div className="w-full md:w-1/2 bg-sky-100 p-4 flex flex-col border-b md:border-b-0 md:border-r border-sky-200">
          <h3 className="text-xl font-bold text-sky-700 mb-4 flex items-center">
            <Package className="mr-2" /> èŠ±åº—ç¾å ´
          </h3>

          {/* Top Shelf: Original Bouquets */}
          <div className="bg-white/60 rounded-xl p-4 mb-4 shadow-sm min-h-[120px]">
            <div className="flex justify-between items-center mb-2">
              <span className="text-sm font-bold text-gray-500">åŸæœ‰èŠ±æŸ (11æŸ)</span>
              {showFinalTotal && <span className="text-sm font-bold text-green-600 animate-bounce">ç¸½å…± 24 æŸ!</span>}
            </div>
            <div className="flex flex-wrap content-start">
              {Array.from({ length: originalBouquets }).map((_, i) => (
                <BouquetIcon key={`orig-${i}`} count={1} color="text-rose-400" />
              ))}
              {/* Animated New Bouquets moving here */}
              {step === 2 && Array.from({ length: newBouquets }).map((_, i) => (
                <div key={`moved-${i}`} className="animate-in fade-in zoom-in duration-500">
                  <BouquetIcon count={1} color="text-rose-600" />
                </div>
              ))}
            </div>
          </div>

          {/* Bottom Area: Packing Station */}
          <div className="bg-orange-50 rounded-xl p-4 flex-grow shadow-inner border border-orange-100 relative">
            <span className="text-sm font-bold text-orange-400 block mb-2">åŒ…è£å·¥ä½œå°</span>
            
            <div className="flex justify-between items-end h-full">
              {/* Loose Roses Bin */}
              <div className="flex flex-col items-center justify-end w-1/3">
                <div className="relative w-24 h-24 md:w-32 md:h-32 bg-red-100 rounded-full flex items-center justify-center border-4 border-red-200 shadow-inner overflow-hidden transition-all duration-300" style={{ transform: `scale(${0.5 + (currentLoose/156)*0.5})` }}>
                  <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/flower.png')]"></div>
                  <span className="text-2xl md:text-3xl font-bold text-red-500">{currentLoose}</span>
                  <span className="text-xs text-red-400 absolute bottom-4">ææ•£è£</span>
                </div>
              </div>

              {/* Arrow Animation */}
              <div className="flex-1 flex justify-center items-center pb-8">
                {isPacking ? (
                  <div className="flex space-x-1 animate-pulse">
                    <div className="w-2 h-2 bg-orange-400 rounded-full"></div>
                    <div className="w-2 h-2 bg-orange-400 rounded-full"></div>
                    <div className="w-2 h-2 bg-orange-400 rounded-full"></div>
                    <span className="text-orange-500 font-bold text-xs">åŒ…è£ä¸­...</span>
                  </div>
                ) : (
                  <span className="text-gray-300 text-2xl">â”</span>
                )}
              </div>

              {/* New Bouquets Accumulation */}
              <div className="w-1/3 flex flex-col items-center justify-end min-h-[100px]">
                <div className="flex flex-wrap justify-center items-end content-end w-full">
                  {step === 1 && Array.from({ length: newBouquets }).map((_, i) => (
                    <div key={`new-${i}`} className="animate-in slide-in-from-left duration-300">
                      <BouquetIcon count={1} color="text-rose-600" />
                    </div>
                  ))}
                  {step === 2 && <div className="text-gray-400 italic text-sm">å·²ç§»è‡³ä¸Šæ–¹</div>}
                </div>
                {step === 1 && <span className="text-rose-600 font-bold mt-2">{newBouquets} æŸ (æ–°)</span>}
              </div>
            </div>
          </div>
        </div>

        {/* Right: Interaction Panel */}
        <div className="w-full md:w-1/2 p-6 flex flex-col justify-center bg-white relative">
          
          {/* Feedback Message */}
          <div className={`absolute top-0 left-0 right-0 p-3 text-center text-sm font-bold transition-colors duration-300 ${
            feedbackType === 'success' ? 'bg-green-100 text-green-700' : 
            feedbackType === 'error' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'
          }`}>
            {feedback || "è«‹é¸æ“‡æ¨¡å¼é–‹å§‹"}
          </div>

          <div className="mt-12 flex-grow flex flex-col justify-center">
            
            {/* Mode Selection */}
            {mode === 'menu' && (
              <div className="space-y-4">
                <button 
                  onClick={() => handleModeSelect('demo')}
                  className="w-full py-4 bg-purple-500 hover:bg-purple-600 text-white rounded-xl shadow-md flex items-center justify-center text-lg font-bold transition-transform hover:scale-105"
                >
                  <Play className="mr-2" /> è‡ªå‹•æ¼”ç¤º (çœ‹è€å¸«åš)
                </button>
                <button 
                  onClick={() => handleModeSelect('interactive')}
                  className="w-full py-4 bg-sky-500 hover:bg-sky-600 text-white rounded-xl shadow-md flex items-center justify-center text-lg font-bold transition-transform hover:scale-105"
                >
                  <Calculator className="mr-2" /> äº’å‹•è§£é¡Œ (æˆ‘è‡ªå·±åš)
                </button>
              </div>
            )}

            {/* Step 1: Division */}
            {mode !== 'menu' && (
              <div className={`transition-all duration-500 ${step === 2 && mode === 'interactive' ? 'opacity-50 pointer-events-none filter blur-[1px]' : 'opacity-100'}`}>
                <div className="flex items-center mb-2">
                  <div className="bg-sky-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-2">1</div>
                  <h3 className="text-lg font-bold text-gray-700">å…ˆç®—ï¼š156 æå¯ä»¥åŒ…æˆå¹¾æŸï¼Ÿ</h3>
                </div>
                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 flex items-center justify-center space-x-2 mb-6">
                  <input 
                    type="number" 
                    value={inputDiv1}
                    onChange={(e) => setInputDiv1(e.target.value)}
                    readOnly={mode === 'demo' || step === 2}
                    className="w-20 p-2 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-sky-500 outline-none"
                    placeholder="?"
                  />
                  <span className="text-2xl text-gray-400">Ã·</span>
                  <input 
                    type="number" 
                    value={inputDiv2}
                    onChange={(e) => setInputDiv2(e.target.value)}
                    readOnly={mode === 'demo' || step === 2}
                    className="w-16 p-2 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-sky-500 outline-none"
                    placeholder="?"
                  />
                  <span className="text-2xl text-gray-400">=</span>
                  <input 
                    type="number" 
                    value={inputDivAns}
                    onChange={(e) => setInputDivAns(e.target.value)}
                    readOnly={mode === 'demo' || step === 2}
                    className="w-20 p-2 text-center text-xl font-bold border-2 border-sky-300 bg-sky-50 text-sky-700 rounded-lg focus:border-sky-500 outline-none"
                    placeholder="?"
                  />
                  <span className="text-gray-500 font-bold ml-2">æŸ</span>
                </div>
                {mode === 'interactive' && step === 1 && (
                  <button 
                    onClick={checkStep1}
                    disabled={isPacking}
                    className="w-full py-2 bg-sky-500 text-white rounded-lg font-bold shadow hover:bg-sky-600 disabled:bg-gray-300"
                  >
                    æª¢æŸ¥ç­”æ¡ˆ & åŒ…è£
                  </button>
                )}
              </div>
            )}

            {/* Divider */}
            {mode !== 'menu' && <div className="h-px bg-gray-200 my-6"></div>}

            {/* Step 2: Addition */}
            {mode !== 'menu' && step === 2 && (
              <div className="animate-in slide-in-from-bottom duration-500">
                <div className="flex items-center mb-2">
                  <div className="bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-2">2</div>
                  <h3 className="text-lg font-bold text-gray-700">å†ç®—ï¼šç¾åœ¨ç¸½å…±æœ‰å¹¾æŸï¼Ÿ</h3>
                </div>
                <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 flex items-center justify-center space-x-2 mb-6">
                   <input 
                    type="number" 
                    value={inputAdd1}
                    onChange={(e) => setInputAdd1(e.target.value)}
                    readOnly={mode === 'demo' || showFinalTotal}
                    className="w-16 p-2 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none"
                    placeholder="?"
                  />
                  <span className="text-2xl text-gray-400">+</span>
                  <input 
                    type="number" 
                    value={inputAdd2}
                    onChange={(e) => setInputAdd2(e.target.value)}
                    readOnly={mode === 'demo' || showFinalTotal}
                    className="w-16 p-2 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none"
                    placeholder="?"
                  />
                  <span className="text-2xl text-gray-400">=</span>
                  <input 
                    type="number" 
                    value={inputAddAns}
                    onChange={(e) => setInputAddAns(e.target.value)}
                    readOnly={mode === 'demo' || showFinalTotal}
                    className="w-20 p-2 text-center text-xl font-bold border-2 border-green-300 bg-green-50 text-green-700 rounded-lg focus:border-green-500 outline-none"
                    placeholder="?"
                  />
                  <span className="text-gray-500 font-bold ml-2">æŸ</span>
                </div>
                {mode === 'interactive' && !showFinalTotal && (
                  <button 
                    onClick={checkStep2}
                    className="w-full py-2 bg-green-500 text-white rounded-lg font-bold shadow hover:bg-green-600"
                  >
                    æª¢æŸ¥æœ€çµ‚ç­”æ¡ˆ
                  </button>
                )}
                
                {/* Final Success Message & Equation */}
                {showFinalTotal && (
                  <div className="text-center animate-in zoom-in duration-500 mt-4 p-4 bg-yellow-100 rounded-xl border-2 border-yellow-300">
                    <h2 className="text-2xl font-bold text-yellow-700 mb-1">ğŸ‰ ç­”å°äº†ï¼</h2>
                    <p className="text-yellow-800 font-medium">èŠ±åº—ç¾åœ¨å…±æœ‰ 24 æŸç«ç‘°ï¼</p>
                    
                    {/* Full Equation Display */}
                    <div className="mt-4 pt-3 border-t border-yellow-200/60">
                      <p className="text-sm text-yellow-800/80 mb-2 font-bold tracking-wide">å®Œæ•´åˆ—å¼ï¼š</p>
                      <div className="text-xl md:text-2xl font-mono text-yellow-900 bg-white/60 rounded-lg p-3 shadow-sm inline-block tracking-wider">
                        11 + (156 Ã· 12) = 24
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Reset Button */}
          {mode !== 'menu' && (
            <div className="mt-4 pt-4 border-t border-gray-100 flex justify-center">
              <button 
                onClick={() => setMode('menu')}
                className="flex items-center text-gray-400 hover:text-gray-600 font-medium text-sm"
              >
                <RotateCcw size={16} className="mr-1" /> å›ä¸»é¸å–®
              </button>
            </div>
          )}
        </div>
      </div>
      
      <div className="mt-8 text-gray-400 text-sm">
        å°ˆç‚ºå°å­¸ç”Ÿè¨­è¨ˆçš„æ•¸å­¸äº’å‹•æ•™å­¸
      </div>
    </div>
  );
};

export default FlowerShopMath;
